# 要求仕様書 (2025-09-18 セッション)

## 概要
- プラグイン名: AtmosViz
- 目的: Dolby Atmos 7.1.4 入力ストリームを 3D 空間に可視化し、各スピーカーの指向性・出力レベルを直感的に把握可能にする。
- 対象環境: Windows / Visual Studio 2022 (JUCE 8.0.1 ベース)

## 機能要件
1. **入出力構成**
   - 入力: Dolby Atmos 7.1.4 バス。
   - 出力: モニタリング専用のサイレント出力。
2. **スピーカー配置**
   - Dolby 推奨角度・高さを採用した 12 スピーカー (7.1.4) プリセット。
   - 初期状態 (Home/Inside) はリスニングポジションからセンター/フロント L,R を正面に見る状態。
3. **3D 可視化**
   - スピーカー位置を球体で表示し、指向性は View Mode で選択した方式 (Directional Lobes ほか) で可視化して RMS 量を強調。
- View Mode プルダウン (Zoom スライダー直下) で `Directional Lobes` / `Layered Lobes` / `Directivity Balloon` / `Radiation Heatmap` / `Temporal Trails` を切り替え。
- Slider Mode (Zoom / Draw Scale) で共通スライダーの機能を切替え。Draw Scale では ±100 → 約0.5×〜2.0×、初期値 0 で最大入力時に反対側へ到達。
  - Directional: 既存の扇形ローブで指向を鋭く表示。
  - Layered: 3 層ローブで想定帯域の広がり差を表現。
  - Directivity Balloon: 指向性バルーン状の楕円シェルで等レベル面を疑似表示 (LFE は球状)。
  - Radiation Heatmap: 室内グリッドへの逆二乗・指向性推定で半透明ヒートマップを重畳。
  - Temporal Trails: スピーカ軌跡をトレイルと方向線で提示。
   - LFE は球のみ表示。
   - ルームワイヤーフレーム: 内部視点では全実線、外部視点では前面実線・背面破線。
   - 原点に XYZ ギズモを表示。
4. **カメラ操作**
   - プリセットは 2 行構成で配置し、各行の最左列にラベル `Outside` / `Inside` を固定する。ラベル右には `[Home][User][Front][Back][Left][Right][Top]` を横並びで配置し、`Bottom` ビューは廃止する。
   - Outside 行のボタンは室外視点の各プリセットを呼び出し、Home は部屋全体が必ず収まる距離に固定された遠距離基準俯瞰、User は室外用カスタム視点を保持するスロット（初期値はフロントを含む斜め俯瞰ビュー）、Front/Back/Left/Right は各面の外側から法線方向を向いて部屋を箱状に捉え、Top は天井のさらに上から真下を向き、天井面とトップスピーカーを俯瞰する。
   - Inside 行のボタンは原点固定カメラによる室内視点を呼び出し、Home はリスニングポジション正面（カメラ位置は常に原点＝リスニング位置に固定）、User は原点固定のままユーザー調整した yaw/pitch/ズームを保持するスロット（初期値はフロントを含む斜め俯瞰ビュー）、Front/Back/Left/Right は向きをそれぞれ +Z/-Z/-X/+X へ切り替えて左右反転も正しく扱い、Top は原点位置から真上（+Y）を向いて天井面とトップスピーカーを俯瞰する室内視点。
   - Outside 行はいずれも `cameraInside = false` で遠距離俯瞰、Inside 行はいずれも `cameraInside = true` でカメラ位置を原点に固定する。
   - Outside と Inside の User 視点は互いに独立しており、それぞれの行で保存・呼び戻しが可能。
5. **ズーム/距離制御**
   - ズームスライダーは Home 視点を 100% とした倍率制御で、範囲は 10%〜200%、既定値は 100%（UI 表示: `Zoom (10%–200%)`）。
   - Outside は Home 時の基準距離（約 40 m）を 100% とし、倍率に応じて距離を算出（倍率が大きいほど近づき、小さいほど離れる）。
   - Inside は Home 時の視野/スケールを 100% とし、倍率に応じて原点固定のまま FOV 相当を調整（倍率が大きいほど近づく）。
6. **ビルド/配置**
   - Visual Studio 2022 でビルドし、生成された `AtmosViz.vst3` を `%COMMONPROGRAMFILES%\VST3` へコピーして使用。

## 非機能要件
- レイテンシ: 音声処理への影響がないこと (軽量解析)。
- フレームレート: 60 fps を目標。
- コード規約: C++17 / JUCE のスタイルに準拠。

## 今後の検討事項
- ユーザー設定の永続化 (プリセット保存)。
- LFE 表現・カラーマッピングの拡張オプション。
- GUI テーマやローブ形状のカスタマイズ機能。
